#!/bin/bash
# kubctl-0x03 - Perform Rolling Update of Django App without downtime

set -e

DEPLOYMENT_NAME="django-blue"
SERVICE_NAME="django-service"
NAMESPACE="default"

echo "=== Applying updated blue_deployment.yaml ==="
kubectl apply -f blue_deployment.yaml -n $NAMESPACE

echo "=== Starting Rolling Update ==="
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE &

ROLL_PID=$!

echo "=== Testing app availability with curl during rollout ==="
SERVICE_IP=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.clusterIP}')

for i in {1..30}; do
  if curl -s http://$SERVICE_IP:8000/ > /dev/null; then
    echo "[$i] App responded successfully"
  else
    echo "[$i] App request FAILED (possible downtime)"
  fi
  sleep 2
done

wait $ROLL_PID

echo "=== Rolling Update Completed ==="
echo "=== Verifying current pods ==="
kubectl get pods -l app=django-messaging,version=blue -n $NAMESPACE -o wide
